CC=@CC@
CFLAGS=-Wall -Wextra -Wno-missing-braces @DISTRO@
OBJ=wsi.o disasm.o run.o parse.o compile.o tcc.o asm.tab.o asm_gen.o lex.yy.o

.PHONY: clean fix-libtcc cloc test

wsi: $(OBJ)
	$(CC) $(CFLAGS) -o $@ $^ @LIBS@

lex.yy.c: asm.l
	flex -f asm.l

asm.tab.c asm.tab.h: asm.y
	bison -d asm.y

test: wsi
	echo "8\n4\n" | ./test_asm.sh divc.asm c81e728d9d4c2f636f067f89cc14862c
	echo "2\n5\n" | ./test_asm.sh mmltz.asm 50585be4e3159a71c874c590d2ba12ec
	./wsi -d tests/hanoi.ws > tests/hanoi.ws.asm
	./wsi -m tests/hanoi.ws.asm > tests/hanoi.ws.asm.ws
	echo "5\n" | ./test_single.sh "" hanoi.ws 888e3997776c0eed8692a9ff27924752
	echo "5\n" | ./test_single.sh "" hanoi.ws.asm.ws 888e3997776c0eed8692a9ff27924752
ifeq (@TEST_JIT@,1)
	echo "5\n" | ./test_single.sh -j hanoi.ws 888e3997776c0eed8692a9ff27924752
	echo "5\n" | ./test_single.sh -j hanoi.ws.asm.ws 888e3997776c0eed8692a9ff27924752
	echo "2\n5\n" | ./test_single.sh -j mmltz.asm.ws 50585be4e3159a71c874c590d2ba12ec
	echo "8\n4\n" | ./test_single.sh -j divc.asm.ws c81e728d9d4c2f636f067f89cc14862c
	./test_single.sh -j cellsize.ws 8b147477cb4b551dfbbbe4443cc4c2c8
	./test_single.sh -j count.ws 3b0332e02daabf31651a5a0d81ba830a
	echo 8 | ./test_single.sh -j fact.ws d1949440d4e507dfa54f2d17a760cde8
	./test_single.sh -j nerd.ws 33635b4760a38088a82c0cc72d7de0d2
endif
	./test_single.sh "" cellsize.ws 8b147477cb4b551dfbbbe4443cc4c2c8
	./test_single.sh "" count.ws 3b0332e02daabf31651a5a0d81ba830a
	echo 8 | ./test_single.sh "" fact.ws d1949440d4e507dfa54f2d17a760cde8
	./test_single.sh "" nerd.ws 33635b4760a38088a82c0cc72d7de0d2
	./test_single.sh "" spec_zero.ws cfcd208495d565ef66e7dff9f98764da

%.o: %.c
	$(CC) $(CFLAGS) -c -o $@ $<

clean:
	rm -f *.o *~ config.log config.status
	rm -f lex.yy.c asm.tab.c asm.tab.h
	rm -f tests/*.asm.ws tests/*.ws.asm
	rm -rf autom4te.cache/

cloc: clean
	cloc --exclude-list-file=.clocignore .

# there are many possible fixes to that, so we'll just try applying every
# of them. if you're a maintainer of ubuntu, debian, or tcc: if you don't
# patch this, I won't remove this ugly hack.
fix-libtcc:
	# hack debian
	-mkdir /usr/lib/x86_64-linux-gnu/tcc/
	-cp /usr/lib/x86_64-linux-gnu/libtcc.a /usr/lib/x86_64-linux-gnu/tcc/libtcc1.a
	# hack ubuntu
	-cp /usr/lib/x86_64-linux-gnu/tcc/libtcc1.a /usr/local/lib/tcc/
	# hack the planet
